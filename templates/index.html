<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Comment Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f3f4f6; font-family: sans-serif; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1); }
        .chart-container { background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1); }
    </style>
</head>
<body class="p-8">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">TikTok Comment Dashboard</h1>
        
        <div class="mb-6">
            <label for="video-select" class="block text-sm font-medium text-gray-700">Pilih Video untuk Dianalisis:</label>
            <select id="video-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                <option value="">-- Pilih Video --</option>
                {% for video in videos %}
                    <option value="{{ video }}">{{ video }}</option>
                {% endfor %}
            </select>
        </div>

        <div id="dashboard-content" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="stat-card text-center"><h2 class="text-lg font-medium text-gray-500">Total Komentar Utama</h2><p id="total-comments" class="text-4xl font-bold text-indigo-600">0</p></div>
                <div class="stat-card text-center"><h2 class="text-lg font-medium text-gray-500">Total Balasan</h2><p id="total-replies" class="text-4xl font-bold text-indigo-600">0</p></div>
                <div class="stat-card text-center"><h2 class="text-lg font-medium text-gray-500">Total Like</h2><p id="total-likes" class="text-4xl font-bold text-indigo-600">0</p></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="chart-container">
                    <h3 class="font-semibold mb-2">Analisis Sentimen</h3>
                    <canvas id="sentimentChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="font-semibold mb-2">Top 5 Komentator</h3>
                    <canvas id="topCommentersChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="font-semibold mb-2">Aktivitas Komentar per Jam</h3>
                    <canvas id="hourlyActivityChart"></canvas>
                </div>
                <div class="chart-container lg:col-span-3">
                    <h3 class="font-semibold mb-2">Top 5 Komentar Paling Disukai</h3>
                    <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Komentar</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Likes</th></tr></thead><tbody id="top-comments-table" class="bg-white divide-y divide-gray-200"></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('video-select').addEventListener('change', function() {
            const videoId = this.value;
            if (videoId) { fetchData(videoId); } 
            else { document.getElementById('dashboard-content').classList.add('hidden'); }
        });

        let topCommentersChartInstance, hourlyActivityChartInstance, sentimentChartInstance; // REVISI: Tambahkan instance untuk chart sentimen

        async function fetchData(videoId) {
            const response = await fetch(`/api/data/${videoId}`);
            const data = await response.json();

            document.getElementById('dashboard-content').classList.remove('hidden');

            // Isi Statistik
            document.getElementById('total-comments').textContent = data.stats.total_comments.toLocaleString('id-ID');
            document.getElementById('total-replies').textContent = data.stats.total_replies.toLocaleString('id-ID');
            document.getElementById('total-likes').textContent = data.stats.total_likes.toLocaleString('id-ID');

            // --- Buat Grafik Sentimen (BAGIAN BARU) ---
            const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');
            const sentimentData = data.sentiment_analysis;
            if (sentimentChartInstance) sentimentChartInstance.destroy();
            sentimentChartInstance = new Chart(sentimentCtx, {
                type: 'pie',
                data: {
                    labels: ['Positif', 'Negatif', 'Netral'],
                    datasets: [{
                        label: 'Sentimen Komentar',
                        data: [sentimentData.positif, sentimentData.negatif, sentimentData.netral],
                        backgroundColor: ['#22c55e', '#ef4444', '#6b7280'],
                        hoverOffset: 4
                    }]
                }
            });
            // --- Akhir Bagian Baru ---

            // Buat Grafik Top Komentator
            const commentersCtx = document.getElementById('topCommentersChart').getContext('2d');
            if (topCommentersChartInstance) topCommentersChartInstance.destroy();
            topCommentersChartInstance = new Chart(commentersCtx, {
                type: 'bar',
                data: {
                    labels: data.top_commenters.map(c => c.username),
                    datasets: [{ label: 'Jumlah Komentar', data: data.top_commenters.map(c => c.count), backgroundColor: 'rgba(79, 70, 229, 0.8)' }]
                },
                options: { indexAxis: 'y' }
            });

            // Buat Grafik Aktivitas per Jam
            const hourlyCtx = document.getElementById('hourlyActivityChart').getContext('2d');
            const hourlyData = new Array(24).fill(0);
            data.comments_per_hour.forEach(item => { hourlyData[item.create_time] = item.count; });
            if (hourlyActivityChartInstance) hourlyActivityChartInstance.destroy();
            hourlyActivityChartInstance = new Chart(hourlyCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [{ label: 'Jumlah Komentar', data: hourlyData, borderColor: 'rgba(79, 70, 229, 0.8)', tension: 0.1, fill: true }]
                }
            });

            // Isi Tabel Top Komentar
            const topCommentsTable = document.getElementById('top-comments-table');
            topCommentsTable.innerHTML = '';
            data.top_comments_by_like.forEach(comment => {
                topCommentsTable.innerHTML += `<tr><td class="px-6 py-4 text-sm font-medium text-gray-900">${comment.username}</td><td class="px-6 py-4 max-w-md truncate text-sm text-gray-500">${comment.comment_text}</td><td class="px-6 py-4 text-sm text-gray-500">${comment.like_count.toLocaleString('id-ID')}</td></tr>`;
            });
        }
    </script>
</body>
</html>